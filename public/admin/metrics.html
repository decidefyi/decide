<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>decide metrics</title>
  <style>
    :root{
      --bg:#111111;
      --card:#1b1b1b;
      --text:#f5f5f5;
      --muted:#a1a1aa;
      --line:#2a2a2a;
    }
    body{
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:24px;
    }
    h1{margin:0 0 8px;font-size:34px;letter-spacing:-0.03em}
    p{margin:0;color:var(--muted)}
    .note{margin-top:8px;font-size:13px}
    .grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
      margin-top:20px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    .k{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em}
    .v{font-size:28px;font-weight:700;margin-top:6px}
    .panel{
      margin-top:16px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:9px 4px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em}
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    button{
      background:#f5f5f5;
      color:#111111;
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
    }
    @media(max-width:900px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media(max-width:560px){
      body{padding:14px}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <h1>Runtime metrics</h1>
      <p>Quick traction view for demos and screenshots.</p>
      <p class="note">Source: <span id="src">loading...</span></p>
    </div>
    <button id="refreshBtn" type="button">Refresh</button>
  </div>

  <div class="grid">
    <div class="card"><div class="k">Total events</div><div class="v" id="totalEvents">0</div></div>
    <div class="card"><div class="k">Last hour</div><div class="v" id="lastHour">0</div></div>
    <div class="card"><div class="k">Last 24h</div><div class="v" id="last24">0</div></div>
    <div class="card"><div class="k">Last 7d</div><div class="v" id="last7d">0</div></div>
  </div>

  <div class="panel">
    <div class="k">Top events (24h)</div>
    <table>
      <thead><tr><th>Event</th><th>Count</th></tr></thead>
      <tbody id="eventRows"></tbody>
    </table>
  </div>

  <div class="panel">
    <div class="k">Meta</div>
    <p id="metaLine" style="margin-top:8px;color:var(--muted)">-</p>
  </div>

  <script>
    const totalEvents = document.getElementById('totalEvents');
    const lastHour = document.getElementById('lastHour');
    const last24 = document.getElementById('last24');
    const last7d = document.getElementById('last7d');
    const eventRows = document.getElementById('eventRows');
    const src = document.getElementById('src');
    const metaLine = document.getElementById('metaLine');
    const refreshBtn = document.getElementById('refreshBtn');

    async function loadMetrics() {
      try {
        const res = await fetch('/api/metrics');
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'metrics failed');

        totalEvents.textContent = String(data.total_events || 0);
        lastHour.textContent = String(data.events_last_hour || 0);
        last24.textContent = String(data.events_last_24h || 0);
        last7d.textContent = String(data.events_last_7d || 0);
        src.textContent = `${data.source} (${data.axiom_enabled ? 'Axiom configured' : 'Axiom not configured'})`;
        metaLine.textContent = `Updated: ${data.updated_at || 'n/a'} | Runtime buffer: ${data.recent_buffer_size || 0}`;

        const rows = Object.entries(data.by_event_24h || {})
          .sort((a, b) => b[1] - a[1])
          .slice(0, 16);
        eventRows.innerHTML = '';
        if (!rows.length) {
          eventRows.innerHTML = '<tr><td colspan="2" style="color:#a1a1aa">No events yet in this runtime.</td></tr>';
          return;
        }
        for (const [event, count] of rows) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${event}</td><td>${count}</td>`;
          eventRows.appendChild(tr);
        }
      } catch (error) {
        src.textContent = 'error';
        metaLine.textContent = `Failed to load metrics: ${error.message}`;
      }
    }

    refreshBtn.addEventListener('click', loadMetrics);
    loadMetrics();
    setInterval(loadMetrics, 15000);
  </script>
</body>
</html>

