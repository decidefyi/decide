name: Daily Policy Check

on:
  schedule:
    # Run every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: daily-policy-check-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check vendor policy pages
        id: check
        continue-on-error: true
        run: |
          set +e
          output=$(node scripts/check-policies.js 2>&1)
          status=$?
          set -e
          echo "$output"

          if [ "$status" -ne 0 ]; then
            echo "::warning::Policy checker exited with code $status (non-blocking)."
          fi

          extract_output_value() {
            local key="$1"
            echo "$output" | sed -n "s/^${key}=//p" | tail -n1 | tr -d '\r'
          }
          observed_changed_count=$(extract_output_value "OBSERVED_CHANGED_COUNT" | tr -d '[:space:]')
          observed_changed_by_policy=$(extract_output_value "OBSERVED_CHANGED_BY_POLICY")
          observed_changed_sample=$(extract_output_value "OBSERVED_CHANGED_SAMPLE")
          material_changed_count=$(extract_output_value "MATERIAL_CHANGED_COUNT" | tr -d '[:space:]')
          material_changed_by_policy=$(extract_output_value "MATERIAL_CHANGED_BY_POLICY")
          material_changed_sample=$(extract_output_value "MATERIAL_CHANGED_SAMPLE")
          material_diff_sample=$(extract_output_value "MATERIAL_DIFF_SAMPLE")
          changed_count=$(extract_output_value "CHANGED_COUNT" | tr -d '[:space:]')
          changed_by_policy=$(extract_output_value "CHANGED_BY_POLICY")
          changed_sample=$(extract_output_value "CHANGED_SAMPLE")
          pending_count=$(extract_output_value "PENDING_COUNT" | tr -d '[:space:]')
          pending_by_policy=$(extract_output_value "PENDING_BY_POLICY")
          pending_sample=$(extract_output_value "PENDING_SAMPLE")
          pending_detail=$(extract_output_value "PENDING_DETAIL")
          stale_pending_count=$(extract_output_value "STALE_PENDING_COUNT" | tr -d '[:space:]')
          stale_pending_by_policy=$(extract_output_value "STALE_PENDING_BY_POLICY")
          stale_pending_sample=$(extract_output_value "STALE_PENDING_SAMPLE")
          volatile_pending_count=$(extract_output_value "VOLATILE_PENDING_COUNT" | tr -d '[:space:]')
          volatile_pending_by_policy=$(extract_output_value "VOLATILE_PENDING_BY_POLICY")
          volatile_pending_sample=$(extract_output_value "VOLATILE_PENDING_SAMPLE")
          escalation_count=$(extract_output_value "ESCALATION_COUNT" | tr -d '[:space:]')
          escalation_by_policy=$(extract_output_value "ESCALATION_BY_POLICY")
          escalation_sample=$(extract_output_value "ESCALATION_SAMPLE")
          escalation_detail=$(extract_output_value "ESCALATION_DETAIL")
          coverage_gap_count=$(extract_output_value "COVERAGE_GAP_COUNT" | tr -d '[:space:]')
          coverage_gap_by_policy=$(extract_output_value "COVERAGE_GAP_BY_POLICY")
          coverage_gap_sample=$(extract_output_value "COVERAGE_GAP_SAMPLE")

          if [ -z "$material_changed_count" ]; then material_changed_count=0; fi
          if [ -z "$observed_changed_count" ]; then observed_changed_count=0; fi
          if [ -z "$changed_count" ]; then changed_count=$material_changed_count; fi
          if [ -z "$changed_by_policy" ]; then changed_by_policy="$material_changed_by_policy"; fi
          if [ -z "$changed_sample" ]; then changed_sample="$material_changed_sample"; fi
          if [ -z "$pending_count" ]; then pending_count=0; fi
          if [ -z "$stale_pending_count" ]; then stale_pending_count=0; fi
          if [ -z "$volatile_pending_count" ]; then volatile_pending_count=0; fi
          if [ -z "$escalation_count" ]; then escalation_count=0; fi
          if [ -z "$coverage_gap_count" ]; then coverage_gap_count=0; fi
          echo "observed_changed_count=$observed_changed_count" >> "$GITHUB_OUTPUT"
          echo "observed_changed_by_policy=$observed_changed_by_policy" >> "$GITHUB_OUTPUT"
          echo "observed_changed_sample=$observed_changed_sample" >> "$GITHUB_OUTPUT"
          echo "material_changed_count=$material_changed_count" >> "$GITHUB_OUTPUT"
          echo "material_changed_by_policy=$material_changed_by_policy" >> "$GITHUB_OUTPUT"
          echo "material_changed_sample=$material_changed_sample" >> "$GITHUB_OUTPUT"
          echo "material_diff_sample=$material_diff_sample" >> "$GITHUB_OUTPUT"
          echo "changed_count=$changed_count" >> "$GITHUB_OUTPUT"
          echo "changed_by_policy=$changed_by_policy" >> "$GITHUB_OUTPUT"
          echo "changed_sample=$changed_sample" >> "$GITHUB_OUTPUT"
          echo "pending_count=$pending_count" >> "$GITHUB_OUTPUT"
          echo "pending_by_policy=$pending_by_policy" >> "$GITHUB_OUTPUT"
          echo "pending_sample=$pending_sample" >> "$GITHUB_OUTPUT"
          echo "pending_detail=$pending_detail" >> "$GITHUB_OUTPUT"
          echo "stale_pending_count=$stale_pending_count" >> "$GITHUB_OUTPUT"
          echo "stale_pending_by_policy=$stale_pending_by_policy" >> "$GITHUB_OUTPUT"
          echo "stale_pending_sample=$stale_pending_sample" >> "$GITHUB_OUTPUT"
          echo "volatile_pending_count=$volatile_pending_count" >> "$GITHUB_OUTPUT"
          echo "volatile_pending_by_policy=$volatile_pending_by_policy" >> "$GITHUB_OUTPUT"
          echo "volatile_pending_sample=$volatile_pending_sample" >> "$GITHUB_OUTPUT"
          echo "escalation_count=$escalation_count" >> "$GITHUB_OUTPUT"
          echo "escalation_by_policy=$escalation_by_policy" >> "$GITHUB_OUTPUT"
          echo "escalation_sample=$escalation_sample" >> "$GITHUB_OUTPUT"
          echo "escalation_detail=$escalation_detail" >> "$GITHUB_OUTPUT"
          echo "coverage_gap_count=$coverage_gap_count" >> "$GITHUB_OUTPUT"
          echo "coverage_gap_by_policy=$coverage_gap_by_policy" >> "$GITHUB_OUTPUT"
          echo "coverage_gap_sample=$coverage_gap_sample" >> "$GITHUB_OUTPUT"

      - name: Commit updated hashes
        run: |
          set +e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          files=(
            rules/policy-hashes.json
            rules/cancel-policy-hashes.json
            rules/return-policy-hashes.json
            rules/trial-policy-hashes.json
            rules/policy-change-candidates.json
            rules/cancel-policy-change-candidates.json
            rules/return-policy-change-candidates.json
            rules/trial-policy-change-candidates.json
            rules/policy-sources.json
            rules/cancel-policy-sources.json
            rules/return-policy-sources.json
            rules/trial-policy-sources.json
            rules/policy-coverage-state.json
            rules/cancel-policy-coverage-state.json
            rules/return-policy-coverage-state.json
            rules/trial-policy-coverage-state.json
            rules/policy-semantic-state.json
            rules/cancel-policy-semantic-state.json
            rules/return-policy-semantic-state.json
            rules/trial-policy-semantic-state.json
          )

          existing=()
          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              existing+=("$f")
            fi
          done

          if [ "${#existing[@]}" -eq 0 ]; then
            echo "No policy artifacts generated; skipping commit."
            exit 0
          fi

          git add "${existing[@]}"
          if ! git diff --cached --quiet; then
            git commit -m "chore: update policy page hashes [skip ci]"
            git fetch origin main
            git rebase origin/main
            rebase_status=$?
            if [ "$rebase_status" -ne 0 ]; then
              echo "::warning::Pre-push rebase failed; skipping push for this run."
              exit 0
            fi

            git push
            push_status=$?
            if [ "$push_status" -ne 0 ]; then
              echo "::warning::Push failed after pre-push rebase (likely concurrent update). Retrying once..."
              git fetch origin main
              git rebase origin/main
              retry_rebase_status=$?
              if [ "$retry_rebase_status" -ne 0 ]; then
                echo "::warning::Retry rebase failed; skipping push for this run."
                exit 0
              fi

              git push
              retry_push_status=$?
              if [ "$retry_push_status" -ne 0 ]; then
                echo "::warning::Retry push failed; another run likely committed first."
                exit 0
              fi
            fi
          else
            echo "No hash changes to commit."
          fi

          exit 0

      - name: Open issue if policies changed or candidates pending
        if: (steps.check.outputs.material_changed_count && steps.check.outputs.material_changed_count != '0') || (steps.check.outputs.pending_count && steps.check.outputs.pending_count != '0')
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          OBSERVED_CHANGED_COUNT: ${{ steps.check.outputs.observed_changed_count }}
          OBSERVED_CHANGED_BY_POLICY: ${{ steps.check.outputs.observed_changed_by_policy }}
          OBSERVED_CHANGED_SAMPLE: ${{ steps.check.outputs.observed_changed_sample }}
          MATERIAL_CHANGED_COUNT: ${{ steps.check.outputs.material_changed_count }}
          MATERIAL_CHANGED_BY_POLICY: ${{ steps.check.outputs.material_changed_by_policy }}
          MATERIAL_CHANGED_SAMPLE: ${{ steps.check.outputs.material_changed_sample }}
          MATERIAL_DIFF_SAMPLE: ${{ steps.check.outputs.material_diff_sample }}
          CHANGED_COUNT: ${{ steps.check.outputs.changed_count }}
          CHANGED_BY_POLICY: ${{ steps.check.outputs.changed_by_policy }}
          CHANGED_SAMPLE: ${{ steps.check.outputs.changed_sample }}
          PENDING_COUNT: ${{ steps.check.outputs.pending_count }}
          PENDING_BY_POLICY: ${{ steps.check.outputs.pending_by_policy }}
          PENDING_SAMPLE: ${{ steps.check.outputs.pending_sample }}
          PENDING_DETAIL: ${{ steps.check.outputs.pending_detail }}
          STALE_PENDING_COUNT: ${{ steps.check.outputs.stale_pending_count }}
          STALE_PENDING_BY_POLICY: ${{ steps.check.outputs.stale_pending_by_policy }}
          STALE_PENDING_SAMPLE: ${{ steps.check.outputs.stale_pending_sample }}
          VOLATILE_PENDING_COUNT: ${{ steps.check.outputs.volatile_pending_count }}
          VOLATILE_PENDING_BY_POLICY: ${{ steps.check.outputs.volatile_pending_by_policy }}
          VOLATILE_PENDING_SAMPLE: ${{ steps.check.outputs.volatile_pending_sample }}
          ESCALATION_COUNT: ${{ steps.check.outputs.escalation_count }}
          ESCALATION_BY_POLICY: ${{ steps.check.outputs.escalation_by_policy }}
          ESCALATION_SAMPLE: ${{ steps.check.outputs.escalation_sample }}
          ESCALATION_DETAIL: ${{ steps.check.outputs.escalation_detail }}
          COVERAGE_GAP_COUNT: ${{ steps.check.outputs.coverage_gap_count }}
          COVERAGE_GAP_BY_POLICY: ${{ steps.check.outputs.coverage_gap_by_policy }}
          COVERAGE_GAP_SAMPLE: ${{ steps.check.outputs.coverage_gap_sample }}
        with:
          retries: 3
          script: |
            const observedCount = Number.parseInt(process.env.OBSERVED_CHANGED_COUNT || '0', 10) || 0;
            const observedByPolicy = process.env.OBSERVED_CHANGED_BY_POLICY || '';
            const observedSample = process.env.OBSERVED_CHANGED_SAMPLE || '';
            const materialCount = Number.parseInt(process.env.MATERIAL_CHANGED_COUNT || '0', 10) || 0;
            const materialByPolicy = process.env.MATERIAL_CHANGED_BY_POLICY || '';
            const materialSample = process.env.MATERIAL_CHANGED_SAMPLE || '';
            const materialDiffSample = process.env.MATERIAL_DIFF_SAMPLE || '';
            const changedCount = Number.parseInt(process.env.CHANGED_COUNT || String(materialCount), 10) || materialCount;
            const changedByPolicy = process.env.CHANGED_BY_POLICY || materialByPolicy;
            const changedSample = process.env.CHANGED_SAMPLE || materialSample;
            const pendingCount = Number.parseInt(process.env.PENDING_COUNT || '0', 10) || 0;
            const pendingByPolicy = process.env.PENDING_BY_POLICY || '';
            const pendingSample = process.env.PENDING_SAMPLE || '';
            const pendingDetail = process.env.PENDING_DETAIL || '';
            const stalePendingCount = Number.parseInt(process.env.STALE_PENDING_COUNT || '0', 10) || 0;
            const stalePendingByPolicy = process.env.STALE_PENDING_BY_POLICY || '';
            const stalePendingSample = process.env.STALE_PENDING_SAMPLE || '';
            const volatilePendingCount = Number.parseInt(process.env.VOLATILE_PENDING_COUNT || '0', 10) || 0;
            const volatilePendingByPolicy = process.env.VOLATILE_PENDING_BY_POLICY || '';
            const volatilePendingSample = process.env.VOLATILE_PENDING_SAMPLE || '';
            const escalationCount = Number.parseInt(process.env.ESCALATION_COUNT || '0', 10) || 0;
            const escalationByPolicy = process.env.ESCALATION_BY_POLICY || '';
            const escalationSample = process.env.ESCALATION_SAMPLE || '';
            const escalationDetail = process.env.ESCALATION_DETAIL || '';
            const coverageGapCount = Number.parseInt(process.env.COVERAGE_GAP_COUNT || '0', 10) || 0;
            const coverageGapByPolicy = process.env.COVERAGE_GAP_BY_POLICY || '';
            const coverageGapSample = process.env.COVERAGE_GAP_SAMPLE || '';
            const today = new Date().toISOString().split('T')[0];
            const changedTitlePrefix = `Policy material changes (${today}):`;
            const pendingTitlePrefix = `Policy page checker pending candidates (${today}):`;
            const legacyChangedTitlePrefix = `Policy pages changed (${today}):`;
            const legacyPendingTitlePrefix = `Policy checker pending candidates (${today}):`;
            const sampleList = materialSample
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .slice(0, 10)
              .map((item) => `- \`${item}\``)
              .join('\n');
            const materialByPolicyList = materialByPolicy
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .map((item) => `- ${item.replace(':', ': ')}`)
              .join('\n');
            const observedByPolicyList = observedByPolicy
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .map((item) => `- ${item.replace(':', ': ')}`)
              .join('\n');
            const pendingByPolicyList = pendingByPolicy
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .map((item) => `- ${item.replace(':', ': ')}`)
              .join('\n');
            const staleByPolicyList = stalePendingByPolicy
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .map((item) => `- ${item.replace(':', ': ')}`)
              .join('\n');
            const volatileByPolicyList = volatilePendingByPolicy
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .map((item) => `- ${item.replace(':', ': ')}`)
              .join('\n');
            const escalationByPolicyList = escalationByPolicy
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .map((item) => `- ${item.replace(':', ': ')}`)
              .join('\n');
            const coverageGapByPolicyList = coverageGapByPolicy
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .map((item) => `- ${item.replace(':', ': ')}`)
              .join('\n');

            const pendingDetailList = pendingDetail
              .split(';')
              .map((entry) => entry.trim())
              .filter(Boolean)
              .map((entry) => {
                const [policy, vendorsRaw] = entry.split(':');
                if (!policy || !vendorsRaw) return '';
                const vendors = vendorsRaw
                  .split('|')
                  .map((v) => v.trim())
                  .filter(Boolean)
                  .join(', ');
                return vendors ? `- ${policy}: ${vendors}` : '';
              })
              .filter(Boolean)
              .join('\n');

            const escalationDetailList = escalationDetail
              .split(';')
              .map((entry) => entry.trim())
              .filter(Boolean)
              .map((entry) => {
                const [policy, vendorsRaw] = entry.split(':');
                if (!policy || !vendorsRaw) return '';
                const vendors = vendorsRaw
                  .split('|')
                  .map((v) => v.trim())
                  .filter(Boolean)
                  .join(', ');
                return vendors ? `- ${policy}: ${vendors}` : '';
              })
              .filter(Boolean)
              .join('\n');

            const title = materialCount > 0
              ? `Policy material changes (${today}): ${materialCount} vendor(s)`
              : `Policy page checker pending candidates (${today}): ${pendingCount} candidate(s)`;
            const body = [
              "## Policy checker summary",
              "",
              `Material policy changes: **${materialCount}**`,
              `Observed page-content changes: **${observedCount}**`,
              `Pending candidates (needs confirmation): **${pendingCount}**`,
              "",
              materialByPolicy ? "### By policy\n" + materialByPolicyList + "\n" : "",
              sampleList ? "### Confirmed sample (first 10)\n" + sampleList + "\n" : "",
              materialDiffSample ? `Material diff sample: \`${materialDiffSample}\`\n` : "",
              observedByPolicy ? "### Observed by policy\n" + observedByPolicyList + "\n" : "",
              observedSample ? `Observed sample: \`${observedSample}\`\n` : "",
              pendingByPolicy ? "### Pending by policy\n" + pendingByPolicyList + "\n" : "",
              pendingDetailList ? "### Pending vendors (first slice per policy)\n" + pendingDetailList + "\n" : "",
              pendingSample ? `Pending sample: \`${pendingSample}\`\n` : "",
              stalePendingCount > 0 ? `### Stale pending (>=3 day(s))\n- Total: **${stalePendingCount}**\n${staleByPolicyList}\n${stalePendingSample ? `Sample: \`${stalePendingSample}\`` : ""}\n` : "",
              volatilePendingCount > 0 ? `### Volatile pending (flip_count threshold)\n- Total: **${volatilePendingCount}**\n${volatileByPolicyList}\n${volatilePendingSample ? `Sample: \`${volatilePendingSample}\`` : ""}\n` : "",
              escalationCount > 0 ? `### Escalation candidates (SLA)\n- Total: **${escalationCount}**\n${escalationByPolicyList}\n${escalationDetailList ? `${escalationDetailList}\n` : ""}${escalationSample ? `Sample: \`${escalationSample}\`` : ""}\n` : "",
              coverageGapCount > 0 ? `### Pending without confirm/escalation (coverage gap)\n- Total: **${coverageGapCount}**\n${coverageGapByPolicyList}\n${coverageGapSample ? `Sample: \`${coverageGapSample}\`` : ""}\n` : "",
              "### Full review source",
              "- `rules/policy-change-candidates.json`",
              "- `rules/cancel-policy-change-candidates.json`",
              "- `rules/return-policy-change-candidates.json`",
              "- `rules/trial-policy-change-candidates.json`",
              "- `rules/policy-semantic-state.json`",
              "- `rules/cancel-policy-semantic-state.json`",
              "- `rules/return-policy-semantic-state.json`",
              "- `rules/trial-policy-semantic-state.json`",
              "",
              `Run: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              "",
              "This issue was created automatically by the daily policy-page checker."
            ].filter(Boolean).join("\n");

            try {
              const openPolicyIssues = await github.paginate(github.rest.issues.listForRepo, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'policy-update',
                per_page: 100
              });

              const dailyPrefixes = [
                changedTitlePrefix,
                pendingTitlePrefix,
                legacyChangedTitlePrefix,
                legacyPendingTitlePrefix
              ];
              const existingToday = openPolicyIssues.find((issue) =>
                !issue.pull_request &&
                typeof issue.title === 'string' &&
                dailyPrefixes.some((prefix) => issue.title.startsWith(prefix))
              );

              if (existingToday) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingToday.number,
                  title,
                  body
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingToday.number,
                  body: [
                    `New run update: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                    "",
                    `Material policy changes: **${materialCount}**`,
                    `Observed page-content changes: **${observedCount}**`,
                    `Pending candidates (needs confirmation): **${pendingCount}**`,
                    materialByPolicy ? `Material by policy: ${materialByPolicy}` : "",
                    observedByPolicy ? `Observed by policy: ${observedByPolicy}` : "",
                    pendingByPolicy ? `Pending by policy: ${pendingByPolicy}` : "",
                    pendingDetail ? `Pending detail: ${pendingDetail}` : "",
                    stalePendingCount > 0 ? `Stale pending: ${stalePendingCount} (${stalePendingByPolicy || 'by-policy-unavailable'})` : "",
                    volatilePendingCount > 0 ? `Volatile pending: ${volatilePendingCount} (${volatilePendingByPolicy || 'by-policy-unavailable'})` : "",
                    escalationCount > 0 ? `Escalation candidates: ${escalationCount} (${escalationByPolicy || 'by-policy-unavailable'})` : "",
                    escalationDetail ? `Escalation detail: ${escalationDetail}` : "",
                    coverageGapCount > 0 ? `Coverage gaps: ${coverageGapCount} (${coverageGapByPolicy || 'by-policy-unavailable'})` : "",
                    materialSample ? `Material sample: ${materialSample}` : "",
                    materialDiffSample ? `Material diff sample: ${materialDiffSample}` : "",
                    observedSample ? `Observed sample: ${observedSample}` : "",
                    escalationSample ? `Escalation sample: ${escalationSample}` : "",
                    coverageGapSample ? `Coverage gap sample: ${coverageGapSample}` : "",
                    pendingSample ? `Pending sample: ${pendingSample}` : ""
                  ].filter(Boolean).join("\n")
                });
                console.log(`::notice::Updated existing policy issue #${existingToday.number} for ${today}.`);
                return;
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['policy-update']
              });
            } catch (error) {
              const status = error?.status || "unknown";
              const message = error?.message || "unknown error";
              console.log(`::warning::Could not open policy update issue (status: ${status}): ${message}`);
            }

      - name: Open escalation issue if SLA thresholds are hit
        if: (steps.check.outputs.escalation_count && steps.check.outputs.escalation_count != '0') || (steps.check.outputs.coverage_gap_count && steps.check.outputs.coverage_gap_count != '0')
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          ESCALATION_COUNT: ${{ steps.check.outputs.escalation_count }}
          ESCALATION_BY_POLICY: ${{ steps.check.outputs.escalation_by_policy }}
          ESCALATION_SAMPLE: ${{ steps.check.outputs.escalation_sample }}
          ESCALATION_DETAIL: ${{ steps.check.outputs.escalation_detail }}
          COVERAGE_GAP_COUNT: ${{ steps.check.outputs.coverage_gap_count }}
          COVERAGE_GAP_BY_POLICY: ${{ steps.check.outputs.coverage_gap_by_policy }}
          COVERAGE_GAP_SAMPLE: ${{ steps.check.outputs.coverage_gap_sample }}
        with:
          retries: 3
          script: |
            const escalationCount = Number.parseInt(process.env.ESCALATION_COUNT || '0', 10) || 0;
            const escalationByPolicy = process.env.ESCALATION_BY_POLICY || '';
            const escalationSample = process.env.ESCALATION_SAMPLE || '';
            const escalationDetail = process.env.ESCALATION_DETAIL || '';
            const coverageGapCount = Number.parseInt(process.env.COVERAGE_GAP_COUNT || '0', 10) || 0;
            const coverageGapByPolicy = process.env.COVERAGE_GAP_BY_POLICY || '';
            const coverageGapSample = process.env.COVERAGE_GAP_SAMPLE || '';
            const today = new Date().toISOString().split('T')[0];
            const titlePrefix = `Policy checker escalation (${today}):`;
            const title = `${titlePrefix} ${escalationCount} escalated, ${coverageGapCount} coverage-gap vendor(s)`;
            const body = [
              "## Policy checker escalation summary",
              "",
              `Escalated pending vendors: **${escalationCount}**`,
              escalationByPolicy ? `By policy: ${escalationByPolicy}` : "",
              escalationDetail ? `Detail: ${escalationDetail}` : "",
              escalationSample ? `Sample: \`${escalationSample}\`` : "",
              "",
              `Coverage-gap pending vendors: **${coverageGapCount}**`,
              coverageGapByPolicy ? `By policy: ${coverageGapByPolicy}` : "",
              coverageGapSample ? `Sample: \`${coverageGapSample}\`` : "",
              "",
              "### Tracking files",
              "- `rules/policy-coverage-state.json`",
              "- `rules/cancel-policy-coverage-state.json`",
              "- `rules/return-policy-coverage-state.json`",
              "- `rules/trial-policy-coverage-state.json`",
              "",
              `Run: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              "",
              "This issue was created automatically by the daily policy checker escalation logic."
            ].filter(Boolean).join("\n");

            try {
              const openEscalationIssues = await github.paginate(github.rest.issues.listForRepo, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'policy-escalation',
                per_page: 100
              });

              const existingToday = openEscalationIssues.find((issue) =>
                !issue.pull_request &&
                typeof issue.title === 'string' &&
                issue.title.startsWith(titlePrefix)
              );

              if (existingToday) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingToday.number,
                  body: [
                    `New run update: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                    "",
                    `Escalated pending vendors: **${escalationCount}**`,
                    escalationByPolicy ? `Escalated by policy: ${escalationByPolicy}` : "",
                    escalationDetail ? `Escalated detail: ${escalationDetail}` : "",
                    `Coverage-gap pending vendors: **${coverageGapCount}**`,
                    coverageGapByPolicy ? `Coverage-gap by policy: ${coverageGapByPolicy}` : "",
                    escalationSample ? `Escalation sample: ${escalationSample}` : "",
                    coverageGapSample ? `Coverage-gap sample: ${coverageGapSample}` : ""
                  ].filter(Boolean).join("\n")
                });
                console.log(`::notice::Updated existing escalation issue #${existingToday.number} for ${today}.`);
                return;
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['policy-update', 'policy-escalation']
              });
            } catch (error) {
              const status = error?.status || "unknown";
              const message = error?.message || "unknown error";
              console.log(`::warning::Could not open policy escalation issue (status: ${status}): ${message}`);
            }
