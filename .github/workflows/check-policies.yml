name: Daily Policy Check

on:
  schedule:
    # Run daily at 08:00 UTC
    - cron: "0 8 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check vendor policy pages
        id: check
        continue-on-error: true
        run: |
          set +e
          output=$(node scripts/check-policies.js 2>&1)
          status=$?
          set -e
          echo "$output"

          if [ "$status" -ne 0 ]; then
            echo "::warning::Policy checker exited with code $status (non-blocking)."
          fi

          # Extract changed vendors if any
          if echo "$output" | grep -q "^CHANGED_VENDORS="; then
            changed=$(echo "$output" | grep "^CHANGED_VENDORS=" | cut -d= -f2)
            echo "changed=$changed" >> "$GITHUB_OUTPUT"

            # Extract issue body
            body=$(echo "$output" | sed -n '/^ISSUE_BODY<<EOF$/,/^EOF$/{ /^ISSUE_BODY<<EOF$/d; /^EOF$/d; p; }')
            echo "body<<EOF" >> "$GITHUB_OUTPUT"
            echo "$body" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit updated hashes
        run: |
          set +e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          files=(
            rules/policy-hashes.json
            rules/cancel-policy-hashes.json
            rules/return-policy-hashes.json
            rules/trial-policy-hashes.json
            rules/policy-change-candidates.json
            rules/cancel-policy-change-candidates.json
            rules/return-policy-change-candidates.json
            rules/trial-policy-change-candidates.json
            rules/policy-sources.json
            rules/cancel-policy-sources.json
            rules/return-policy-sources.json
            rules/trial-policy-sources.json
          )

          existing=()
          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              existing+=("$f")
            fi
          done

          if [ "${#existing[@]}" -eq 0 ]; then
            echo "No policy artifacts generated; skipping commit."
            exit 0
          fi

          git add "${existing[@]}"
          if ! git diff --cached --quiet; then
            git commit -m "chore: update policy page hashes [skip ci]"
            git push
            push_status=$?
            if [ "$push_status" -ne 0 ]; then
              echo "::warning::Initial push failed (likely concurrent update). Retrying with rebase..."
              git fetch origin main
              git rebase origin/main
              rebase_status=$?
              if [ "$rebase_status" -ne 0 ]; then
                echo "::warning::Rebase failed; skipping push for this run."
                exit 0
              fi

              git push
              retry_status=$?
              if [ "$retry_status" -ne 0 ]; then
                echo "::warning::Retry push failed; another run likely committed first."
                exit 0
              fi
            fi
          else
            echo "No hash changes to commit."
          fi

          exit 0

      - name: Open issue if policies changed
        if: steps.check.outputs.changed
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          CHANGED_VENDORS: ${{ steps.check.outputs.changed }}
          ISSUE_BODY: ${{ steps.check.outputs.body }}
        with:
          script: |
            const changed = process.env.CHANGED_VENDORS || '';
            const body = process.env.ISSUE_BODY || '';
            const today = new Date().toISOString().split('T')[0];

            // GitHub issue titles have a 256 char limit. Our changed-vendors list can exceed that,
            // so we summarize in the title and keep the full list in the body.
            const changedList = changed.split(',').map(s => s.trim()).filter(Boolean);
            const shortList = changedList.slice(0, 6).join(', ');
            const more = changedList.length > 6 ? ` +${changedList.length - 6} more` : '';
            let title = `Policy pages changed (${today}): ${shortList}${more}`.trim();
            if (title.length > 256) title = title.slice(0, 252) + '...';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: `## Vendor policy pages changed\n\nThe following vendor policy pages have changed since the last check:\n\n${body}\n\nPlease review and update the corresponding rules file if the policy has changed.\n\nThis issue was created automatically by the daily policy checker.`,
              labels: ['policy-update']
            });
