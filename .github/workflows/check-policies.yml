name: Daily Policy Check

on:
  schedule:
    # Run daily at 08:00 UTC
    - cron: "0 8 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check vendor policy pages
        id: check
        run: |
          set +e
          output=$(node scripts/check-policies.js 2>&1)
          status=$?
          set -e
          echo "$output"

          if [ "$status" -ne 0 ]; then
            echo "::warning::Policy checker exited with code $status (non-blocking)."
          fi

          # Extract changed vendors if any
          if echo "$output" | grep -q "^CHANGED_VENDORS="; then
            changed=$(echo "$output" | grep "^CHANGED_VENDORS=" | cut -d= -f2)
            echo "changed=$changed" >> "$GITHUB_OUTPUT"

            # Extract issue body
            body=$(echo "$output" | sed -n '/^ISSUE_BODY<<EOF$/,/^EOF$/{ /^ISSUE_BODY<<EOF$/d; /^EOF$/d; p; }')
            echo "body<<EOF" >> "$GITHUB_OUTPUT"
            echo "$body" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit updated hashes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rules/policy-hashes.json rules/cancel-policy-hashes.json rules/return-policy-hashes.json rules/trial-policy-hashes.json
          if ! git diff --cached --quiet; then
            git commit -m "chore: update policy page hashes [skip ci]"
            git push
          else
            echo "No hash changes to commit."
          fi

      - name: Open issue if policies changed
        if: steps.check.outputs.changed
        uses: actions/github-script@v7
        env:
          CHANGED_VENDORS: ${{ steps.check.outputs.changed }}
          ISSUE_BODY: ${{ steps.check.outputs.body }}
        with:
          script: |
            const changed = process.env.CHANGED_VENDORS || '';
            const body = process.env.ISSUE_BODY || '';
            const today = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Policy page change detected (${today}): ${changed}`,
              body: `## Vendor policy pages changed\n\nThe following vendor policy pages have changed since the last check:\n\n${body}\n\nPlease review and update the corresponding rules file if the policy has changed.\n\nThis issue was created automatically by the daily policy checker.`,
              labels: ['policy-update']
            });
