name: Daily Policy Check

on:
  schedule:
    # Run every 12 hours (00:00 UTC and 12:00 UTC)
    - cron: "0 */12 * * *"
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: daily-policy-check-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check vendor policy pages
        id: check
        continue-on-error: true
        run: |
          set +e
          output=$(node scripts/check-policies.js 2>&1)
          status=$?
          set -e
          echo "$output"

          if [ "$status" -ne 0 ]; then
            echo "::warning::Policy checker exited with code $status (non-blocking)."
          fi

          changed_count=$(echo "$output" | awk -F= '/^CHANGED_COUNT=/{print $2}' | tail -n1 | tr -d '[:space:]')
          changed_by_policy=$(echo "$output" | awk -F= '/^CHANGED_BY_POLICY=/{print $2}' | tail -n1 | tr -d '\r')
          changed_sample=$(echo "$output" | awk -F= '/^CHANGED_SAMPLE=/{print $2}' | tail -n1 | tr -d '\r')

          if [ -n "$changed_count" ]; then
            echo "changed_count=$changed_count" >> "$GITHUB_OUTPUT"
            echo "changed_by_policy=$changed_by_policy" >> "$GITHUB_OUTPUT"
            echo "changed_sample=$changed_sample" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit updated hashes
        run: |
          set +e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          files=(
            rules/policy-hashes.json
            rules/cancel-policy-hashes.json
            rules/return-policy-hashes.json
            rules/trial-policy-hashes.json
            rules/policy-change-candidates.json
            rules/cancel-policy-change-candidates.json
            rules/return-policy-change-candidates.json
            rules/trial-policy-change-candidates.json
            rules/policy-sources.json
            rules/cancel-policy-sources.json
            rules/return-policy-sources.json
            rules/trial-policy-sources.json
          )

          existing=()
          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              existing+=("$f")
            fi
          done

          if [ "${#existing[@]}" -eq 0 ]; then
            echo "No policy artifacts generated; skipping commit."
            exit 0
          fi

          git add "${existing[@]}"
          if ! git diff --cached --quiet; then
            git commit -m "chore: update policy page hashes [skip ci]"
            git push
            push_status=$?
            if [ "$push_status" -ne 0 ]; then
              echo "::warning::Initial push failed (likely concurrent update). Retrying with rebase..."
              git fetch origin main
              git rebase origin/main
              rebase_status=$?
              if [ "$rebase_status" -ne 0 ]; then
                echo "::warning::Rebase failed; skipping push for this run."
                exit 0
              fi

              git push
              retry_status=$?
              if [ "$retry_status" -ne 0 ]; then
                echo "::warning::Retry push failed; another run likely committed first."
                exit 0
              fi
            fi
          else
            echo "No hash changes to commit."
          fi

          exit 0

      - name: Open issue if policies changed
        if: steps.check.outputs.changed_count && steps.check.outputs.changed_count != '0'
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          CHANGED_COUNT: ${{ steps.check.outputs.changed_count }}
          CHANGED_BY_POLICY: ${{ steps.check.outputs.changed_by_policy }}
          CHANGED_SAMPLE: ${{ steps.check.outputs.changed_sample }}
        with:
          retries: 3
          script: |
            const changedCount = Number.parseInt(process.env.CHANGED_COUNT || '0', 10) || 0;
            const changedByPolicy = process.env.CHANGED_BY_POLICY || '';
            const changedSample = process.env.CHANGED_SAMPLE || '';
            const today = new Date().toISOString().split('T')[0];
            const dailyTitlePrefix = `Policy pages changed (${today}):`;
            const sampleList = changedSample
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .slice(0, 10)
              .map((item) => `- \`${item}\``)
              .join('\n');
            const byPolicyList = changedByPolicy
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .map((item) => `- ${item.replace(':', ': ')}`)
              .join('\n');

            const title = `Policy pages changed (${today}): ${changedCount} vendor(s)`;
            const body = [
              "## Vendor policy pages changed",
              "",
              `Total changed vendors: **${changedCount}**`,
              "",
              changedByPolicy ? "### By policy\n" + byPolicyList + "\n" : "",
              sampleList ? "### Sample (first 10)\n" + sampleList + "\n" : "",
              "### Full review source",
              "- `rules/policy-change-candidates.json`",
              "- `rules/cancel-policy-change-candidates.json`",
              "- `rules/return-policy-change-candidates.json`",
              "- `rules/trial-policy-change-candidates.json`",
              "",
              `Run: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              "",
              "This issue was created automatically by the daily policy checker."
            ].filter(Boolean).join("\n");

            try {
              const openPolicyIssues = await github.paginate(github.rest.issues.listForRepo, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'policy-update',
                per_page: 100
              });

              const existingToday = openPolicyIssues.find((issue) =>
                !issue.pull_request && typeof issue.title === 'string' && issue.title.startsWith(dailyTitlePrefix)
              );

              if (existingToday) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingToday.number,
                  body: [
                    `New run update: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                    "",
                    `Updated changed vendor count: **${changedCount}**`,
                    changedByPolicy ? `By policy: ${changedByPolicy}` : "",
                    changedSample ? `Sample: ${changedSample}` : ""
                  ].filter(Boolean).join("\n")
                });
                console.log(`::notice::Updated existing policy issue #${existingToday.number} for ${today}.`);
                return;
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['policy-update']
              });
            } catch (error) {
              const status = error?.status || "unknown";
              const message = error?.message || "unknown error";
              console.log(`::warning::Could not open policy update issue (status: ${status}): ${message}`);
            }
